{% extends "base.html" %}

{% block title %}Documentation - MiniDB Admin{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row g-5">
        <!-- Sticky Sidebar Navigation -->
        <aside class="col-md-3 d-none d-md-block">
            <div class="sticky-top pt-4" style="top: 2rem; z-index: 10;">
                <nav id="toc" class="nav flex-column doc-sidebar">
                    <h6 class="text-uppercase fw-bold mb-3 small text-muted px-3" style="letter-spacing: 0.1em;">
                        Contents</h6>
                    <a class="nav-link py-2" href="#introduction">Introduction</a>
                    <a class="nav-link py-2" href="#sql-commands">SQL Reference</a>
                    <a class="nav-link py-2 ps-4 small" href="#create-table">CREATE TABLE</a>
                    <a class="nav-link py-2 ps-4 small" href="#insert">INSERT INTO</a>
                    <a class="nav-link py-2 ps-4 small" href="#select">SELECT & JOIN</a>
                    <a class="nav-link py-2 ps-4 small" href="#update-delete">UPDATE & DELETE</a>
                    <a class="nav-link py-2" href="#indexing">Indexing & Scaling</a>
                    <a class="nav-link py-2" href="#security">Security</a>
                    <a class="nav-link py-2" href="#concurrency">Concurrency</a>
                    <a class="nav-link py-2" href="#performance">Performance</a>
                    <a class="nav-link py-2" href="#transactions">Transactions</a>
                    <a class="nav-link py-2" href="#python-api">Python API</a>
                    <hr class="my-4 mx-3 opacity-10">
                    <a class="nav-link py-2 text-primary" href="/">
                        <i class="fas fa-arrow-left me-2"></i> Back to Dashboard
                    </a>
                </nav>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="col-md-9 border-start ps-5 pt-4 pb-5 content-area">

            <!-- Introduction -->
            <section id="introduction" class="mb-5">
                <h2 class="fw-bold text-dark mb-4">Introduction</h2>
                <p class="lead text-secondary">
                    MiniDB is a lightweight, high-performance relational database engine written in Python. It is
                    designed for developers who need a simple, file-based RDBMS for prototyping, small applications, or
                    educational purposes.
                </p>
                <p>
                    Unlike traditional databases that require complex server setups, MiniDB stores data in transparent
                    JSON files while maintaining relational features like primary keys, unique constraints, and foreign
                    key integrity.
                </p>

                <h4 class="mt-4 fw-bold">Why MiniDB?</h4>
                <div class="row mt-3 g-4">
                    <div class="col-md-6">
                        <div class="feature-box">
                            <h6 class="fw-bold mb-1">Zero Configuration</h6>
                            <p class="small text-muted mb-0">Just import and start querying. No servers, no sockets.</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="feature-box">
                            <h6 class="fw-bold mb-1">ACID Compliance</h6>
                            <p class="small text-muted mb-0">Full transaction support with BEGIN, COMMIT, and ROLLBACK.
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="feature-box">
                            <h6 class="fw-bold mb-1">Strict Types</h6>
                            <p class="small text-muted mb-0">Enforces INT, STR, and FLOAT types for data reliability.
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="feature-box">
                            <h6 class="fw-bold mb-1">Streaming Storage</h6>
                            <p class="small text-muted mb-0">Uses JSONL for O(1) appends and memory-efficient streaming
                                scans.</p>
                        </div>
                    </div>
                </div>
            </section>

            <hr class="my-5 opacity-10">

            <!-- SQL Reference -->
            <section id="sql-commands" class="mb-5">
                <h2 class="fw-bold text-dark mb-4">SQL Reference</h2>
                <p>MiniDB supports a subset of standard SQL syntax optimized for core relational operations.</p>

                <!-- CREATE TABLE -->
                <div id="create-table" class="mt-5">
                    <h4 class="fw-bold">CREATE TABLE</h4>
                    <p>Defines a new table schema with optional constraints like PRIMARY KEY and FOREIGN KEY.</p>
                    <pre><code class="sql">-- Example Table Definition
CREATE TABLE users (
    id INT PRIMARY KEY,
    name STR UNIQUE,
    email STR,
    department_id INT,
    FOREIGN KEY (department_id) REFERENCES departments(id)
)</code></pre>
                </div>

                <!-- INSERT -->
                <div id="insert" class="mt-5">
                    <h4 class="fw-bold">INSERT INTO</h4>
                    <p>Adds a new record to a table. All columns defined in the schema must be provided in the correct
                        order.</p>
                    <pre><code class="sql">INSERT INTO users VALUES (1, 'Jane Doe', 'jane@example.com', 10)</code></pre>
                </div>

                <!-- SELECT -->
                <div id="select" class="mt-5">
                    <h4 class="fw-bold">SELECT & JOIN</h4>
                    <p>Retrieves data from one or more tables. Supports filtered queries using WHERE, specific column
                        projection, the LIMIT clause, and relational
                        stitching using JOIN.</p>
                    <pre><code class="sql">-- Specific Column Projection
SELECT name, email FROM users WHERE id > 10

-- Depth-Limited Query
SELECT * FROM logs LIMIT 5

-- Relational Join
SELECT * FROM users JOIN departments ON users.department_id = departments.id</code></pre>

                    <h5 class="fw-bold mt-4 small text-uppercase">Nested Subqueries</h5>
                    <p>MiniDB supports recursive subqueries using the <code>IN</code> operator. The inner query is
                        resolved first and its results are used to filter the outer query.</p>
                    <pre><code class="sql">-- Find students enrolled in 'Python'
SELECT * FROM students 
WHERE id IN (SELECT student_id FROM enrollments WHERE course = 'Python')</code></pre>

                    <h5 class="fw-bold mt-4 small text-uppercase">Aggregate Functions</h5>
                    <p>MiniDB provides built-in support for standard SQL aggregates to perform calculations on your
                        data. These functions are executed in a single pass for maximum efficiency.</p>
                    <ul>
                        <li><code>COUNT(*)</code> or <code>COUNT(col)</code> — Total row count or non-null values.</li>
                        <li><code>SUM(col)</code> — Arithmetic total (numeric columns only).</li>
                        <li><code>AVG(col)</code> — Arithmetic mean (numeric columns only).</li>
                        <li><code>MIN(col) / MAX(col)</code> — Boundary values.</li>
                    </ul>
                    <pre><code class="sql">-- Combined Analysis
SELECT AVG(salary), MAX(score), COUNT(*) FROM employees WHERE department = 'Sales'</code></pre>
                </div>

                <!-- UPDATE/DELETE -->
                <div id="update-delete" class="mt-5">
                    <h4 class="fw-bold">UPDATE & DELETE</h4>
                    <p>Modifies or removes existing data based on a condition.</p>
                    <pre><code class="sql">-- Update
UPDATE users SET email = 'new@example.com' WHERE name = 'Jane Doe'

-- Delete
DELETE FROM users WHERE id = 1</code></pre>
                </div>
            </section>

            <hr class="my-5 opacity-10">

            <!-- Indexing & Scaling -->
            <section id="indexing" class="mb-5">
                <h2 class="fw-bold text-dark mb-4">Indexing & Scaling</h2>
                <p>
                    MiniDB is built to handle datasets larger than available RAM by utilizing smart on-disk structures.
                </p>

                <h4 class="fw-bold">Disk-Based Binary Index (O(log N))</h4>
                <p>
                    Unlike many lightweight databases that load their entire index into memory, MiniDB implements a
                    <strong>Disk-Based Binary Search Index</strong>.
                </p>
                <ul>
                    <li><strong>Persistence</strong>: Primary keys and their byte-offsets are stored in
                        <code>.idx</code> binary files.
                    </li>
                    <li><strong>Zero-RAM Lookup</strong>: When searching for a primary key (e.g.,
                        <code>id = 101</code>), the engine performs a binary search directly on the disk file.
                    </li>
                    <li><strong>Seek Performance</strong>: Once the offset is found, the engine uses
                        <code>f.seek()</code> to jump directly to the row in the <code>.jsonl</code> file, avoiding a
                        full table scan.
                    </li>
                </ul>

                <h4 class="fw-bold mt-4">Streaming Scans</h4>
                <p>
                    MiniDB uses Python generators for all table scans (<code>SELECT *</code>). This ensures that even if
                    a table has 10 million rows, only one row is held in memory at any given time.
                </p>
            </section>

            <hr class="my-5 opacity-10">

            <!-- Security -->
            <section id="security" class="mb-5">
                <h2 class="fw-bold text-dark mb-4">Security</h2>
                <p>
                    MiniDB protects your data against common web vulnerabilities, specifically <strong>SQL
                        Injection</strong>.
                </p>

                <h4 class="fw-bold">Parameterized Queries</h4>
                <p>
                    Always use <code>?</code> placeholders when executing queries with user-provided input. This ensures
                    that the input is treated as literal data and not as executable SQL code.
                </p>

                <h6 class="fw-bold mt-3">The Safe Way (Parameterized):</h6>
                <pre><code class="python"># User input is automatically escaped and sanitized
name = "O'Connor'); DROP TABLE users; --"
db.execute_query("INSERT INTO users VALUES (?, ?)", (1, name))</code></pre>

                <h6 class="fw-bold mt-3">The Unsafe Way (String Formatting):</h6>
                <pre><code class="python"># ❌ VULNERABLE TO SQL INJECTION
db.execute_query(f"INSERT INTO users VALUES (1, '{name}')")</code></pre>

                <div class="alert alert-info border-0 bg-light">
                    <i class="fas fa-shield-alt me-2 text-primary"></i>
                    <strong>Auto-Sanitization:</strong> MiniDB automatically escapes single quotes and validates data
                    types (INT/STR/FLOAT) before any insertion or update.
                </div>
            </section>

            <!-- Concurrency -->
            <section id="concurrency" class="mb-5">
                <h2 class="fw-bold text-dark mb-4">Concurrency & Locking</h2>
                <p>
                    MiniDB is designed to be multi-process safe. It ensures that data integrity is maintained even when
                    multiple users or scripts are writing to the database simultaneously.
                </p>

                <h4 class="fw-bold">Pessimistic Locking</h4>
                <p>
                    The engine utilizes a <code>LockManager</code> that enforces file-based locking. When a write
                    operation (INSERT, UPDATE, DELETE) begins:
                </p>
                <ul>
                    <li><strong>Acquisition</strong>: A <code>.lock</code> file is created for the specific table.</li>
                    <li><strong>Exclusion</strong>: Other processes attempting to write to the same table will wait
                        (with a timeout) until the lock is released.</li>
                    <li><strong>Safety</strong>: This prevents the "lost update" problem where two processes overwrite
                        each other's data.</li>
                </ul>
            </section>

            <hr class="my-5 opacity-10">

            <!-- Performance Internals -->
            <section id="performance" class="mb-5">
                <h2 class="fw-bold text-dark mb-4">Performance Internals</h2>
                <p>
                    Behind the scenes, MiniDB uses advanced algorithms to keep your queries fast.
                </p>

                <h4 class="fw-bold">Hash Joins (O(N + M))</h4>
                <p>
                    While basic databases use Nested Loops (slow O(N*M)), MiniDB uses a <strong>Hash Join</strong>:
                </p>
                <ol>
                    <li><strong>Build</strong>: Smallest table is loaded into a temporary memory hash map.</li>
                    <li><strong>Probe</strong>: Larger table is scanned once, and matches are pulled from the hash map
                        in constant time.</li>
                </ol>

                <h4 class="fw-bold mt-4">Atomic Save Strategy</h4>
                <p>
                    MiniDB ensures that a crash mid-save won't corrupt your data. It follows a 3-step process:
                </p>
                <div class="d-flex gap-3 mt-3">
                    <div class="p-3 bg-light rounded-3 flex-fill text-center">
                        <div class="fw-bold text-primary">1. Stage</div>
                        <div class="small">Write to <code>.tmp</code> file</div>
                    </div>
                    <div class="p-3 bg-light rounded-3 flex-fill text-center">
                        <div class="fw-bold text-primary">2. Flush</div>
                        <div class="small">Force <code>fsync</code> to hardware</div>
                    </div>
                    <div class="p-3 bg-light rounded-3 flex-fill text-center">
                        <div class="fw-bold text-primary">3. Swap</div>
                        <div class="small">Atomic <code>os.rename</code></div>
                    </div>
                </div>
            </section>

            <hr class="my-5 opacity-10">

            <!-- Transactions -->
            <section id="transactions" class="mb-5">
                <h2 class="fw-bold text-dark mb-4">Transactions</h2>
                <p>
                    Transactions allow you to group multiple SQL commands into a single atomic operation. This ensures
                    that either all changes are saved at once, or none are.
                </p>

                <h6 class="fw-bold mt-4">Command Flow:</h6>
                <ul>
                    <li><code>BEGIN TRANSACTION;</code> — Starts a new staging area.</li>
                    <li><code>COMMIT;</code> — Safely persists all changes to disk.</li>
                    <li><code>ROLLBACK;</code> — Discards current changes and reverts to previous state.</li>
                </ul>

                <pre><code class="sql">BEGIN TRANSACTION;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
COMMIT;</code></pre>
            </section>

            <hr class="my-5 opacity-10">

            <!-- Python API -->
            <section id="python-api" class="mb-5">
                <h2 class="fw-bold text-dark mb-4">Python API</h2>
                <p>
                    You can integrate MiniDB directly into your Python scripts without the web dashboard.
                </p>

                <pre><code class="python">from minidb import MiniDB

# Initialize the engine
db = MiniDB()

# Execute queries
db.execute_query("CREATE TABLE logs (id INT, event STR)")
db.execute_query("INSERT INTO logs VALUES (1, 'Application Started')")

# Retrieve results
results = db.execute_query("SELECT * FROM logs WHERE event = ?", ("Login",))
print(results)</code></pre>

                <h4 class="fw-bold mt-4">Advanced Querying</h4>
                <p>The <code>execute_query</code> method returns different types based on the command:</p>
                <ul>
                    <li><strong>SELECT</strong>: Returns a <code>list</code> of <code>dict</code> objects.</li>
                    <li><strong>DESCRIBE</strong>: Returns a <code>dict</code> containing schema metadata.</li>
                    <li><strong>INSERT/UPDATE/DELETE</strong>: Returns a success/error <code>str</code>.</li>
                </ul>
            </section>

            <footer class="mt-5 pt-5 border-top text-center text-muted small">
                &copy; 2026 MiniDB Engineering. All rights reserved. Built with Python.
            </footer>
        </main>
    </div>
</div>

<style>
    :root {
        --toc-active: #0d6efd;
        --doc-text: #333333;
        --code-bg: #f5f5f5;
        --code-border: #eeeeee;
        --sidebar-border: #f0f0f0;
    }

    body {
        background-color: #ffffff;
        color: var(--doc-text);
        font-family: 'Inter', -apple-system, system-ui, sans-serif;
    }

    .doc-sidebar .nav-link {
        color: #666;
        border-radius: 4px;
        transition: all 0.2s ease;
        border-left: 2px solid transparent;
        margin-bottom: 2px;
    }

    .doc-sidebar .nav-link:hover {
        background-color: #f8f9fa;
        color: var(--toc-active);
    }

    .doc-sidebar .nav-link.active {
        color: var(--toc-active);
        background-color: rgba(13, 110, 253, 0.05);
        border-left-color: var(--toc-active);
        font-weight: 600;
    }

    /* Content Styling */
    .content-area h2 {
        font-size: 2rem;
        letter-spacing: -0.02em;
    }

    .content-area h4 {
        margin-top: 2.5rem;
        font-size: 1.25rem;
        color: #111;
    }

    p {
        line-height: 1.6;
        margin-bottom: 1.25rem;
    }

    .feature-box {
        padding: 1.25rem;
        border: 1px solid #eee;
        border-radius: 8px;
        height: 100%;
    }

    /* Code Block Styling */
    pre {
        background-color: var(--code-bg);
        border: 1px solid var(--code-border);
        border-radius: 6px;
        padding: 1.25rem;
        margin: 1.5rem 0;
        overflow-x: auto;
    }

    pre code {
        font-family: 'Fira Code', 'Courier New', monospace;
        font-size: 0.9rem;
        color: #333;
    }

    /* Minimal Syntax Highlighting Simulation */
    .sql {
        color: #333;
    }

    code {
        color: #d63384;
    }

    /* Inline code */
</style>

<script>
    // Smooth scrolling and Sidebar activation
    document.addEventListener('DOMContentLoaded', () => {
        const sections = document.querySelectorAll('section, div[id]');
        const navLinks = document.querySelectorAll('.doc-sidebar .nav-link');

        window.addEventListener('scroll', () => {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (pageYOffset >= sectionTop - 100) {
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href').includes(current) && current !== '') {
                    link.classList.add('active');
                }
            });
        });
    });
</script>
{% endblock %}