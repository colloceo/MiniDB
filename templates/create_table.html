{% extends "base.html" %}

{% block title %}Table Designer - MiniDB Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2 dashboard-title">
        <i class="fas fa-magic me-2 text-primary"></i> Table Designer
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="showSQLPreview()">
            <i class="fas fa-code me-1"></i> Preview SQL
        </button>
    </div>
</div>

<!-- Alert Container -->
<div id="alertContainer"></div>

<!-- Table Designer Card -->
<div class="card border-light-gray shadow-xs mb-4">
    <div class="card-body p-4">
        <!-- Header Section -->
        <div class="mb-4 pb-3 border-bottom">
            <h3 class="fw-bold text-dark mb-1">Create New Table</h3>
            <p class="text-muted small">Define your schema, column types, and relational constraints.</p>
            <!-- Store tables for JS access in a safe way -->
            <div id="metadata-store" data-tables='{{ tables | tojson }}' style="display: none;"></div>
        </div>

        <!-- Table Name -->
        <div class="mb-5">
            <label for="tableName" class="section-title mb-2 d-block">
                Table Name
            </label>
            <input type="text" class="form-control form-control-lg enterprise-input" id="tableName"
                placeholder="e.g., employees, products, orders" required>
            <div class="form-text mt-2">Identifiers should be lowercase and contain no spaces.</div>
        </div>

        <!-- Columns Section -->
        <div class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="section-title mb-0">Columns</h6>
                <button type="button" id="add-column-btn" class="btn btn-outline-secondary btn-sm px-3"
                    onclick="addColumn()">
                    <i class="fas fa-plus me-1"></i> Add Column
                </button>
            </div>

            <div id="columnsContainer" class="p-3 bg-light rounded-3 border">
                <!-- Columns will be added here dynamically -->
            </div>
        </div>

        <!-- Foreign Keys Section -->
        <div class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="section-title mb-0">Relationships (Foreign Keys)</h6>
                <button type="button" class="btn btn-outline-secondary btn-sm px-3" onclick="addForeignKey()">
                    <i class="fas fa-link me-1"></i> Add Relationship
                </button>
            </div>

            <div id="foreignKeysContainer" class="p-3 bg-light rounded-3 border">
                <!-- Foreign keys will be added here dynamically -->
                <div class="text-muted text-center py-4" id="noForeignKeys">
                    <i class="fas fa-info-circle me-1"></i> No foreign keys defined yet
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between align-items-center pt-4 border-top">
            <button type="button" class="btn btn-link text-muted text-decoration-none" onclick="resetForm()">
                <i class="fas fa-undo me-1"></i> Reset Form
            </button>
            <button type="button" class="btn btn-primary btn-lg px-5 shadow-sm" onclick="createTable()">
                <i class="fas fa-check-circle me-1"></i> Create Table
            </button>
        </div>
    </div>
</div>

<!-- SQL Preview Modal -->
<div class="modal fade" id="sqlPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-bottom bg-light">
                <h5 class="modal-title fw-bold text-dark"><i class="fas fa-terminal me-2 text-primary"></i> Generated
                    SQL Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <pre class="m-0 p-4 border-0"
                    style="background-color: #fcfcfc;"><code id="sqlPreviewCode" class="text-dark"></code></pre>
            </div>
            <div class="modal-footer border-top bg-light">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary px-4" onclick="copySQL()">
                    <i class="fas fa-clipboard me-1"></i> Copy SQL
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --enterprise-blue: #0d6efd;
        --enterprise-dark: #343a40;
        --enterprise-muted: #6c757d;
        --enterprise-border: #dee2e6;
        --enterprise-bg: #f8f9fa;
    }

    body {
        background-color: var(--enterprise-bg);
    }

    .dashboard-title {
        font-weight: 700;
        color: var(--enterprise-dark);
        letter-spacing: -0.02em;
    }

    .section-title {
        font-size: 0.75rem;
        text-transform: uppercase;
        font-weight: 700;
        color: var(--enterprise-muted);
        letter-spacing: 0.05em;
    }

    .border-light-gray {
        border-color: var(--enterprise-border) !important;
    }

    .shadow-xs {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
    }

    .enterprise-input {
        border-color: var(--enterprise-border);
        border-radius: 6px;
    }

    .enterprise-input:focus {
        border-color: var(--enterprise-blue);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
    }

    /* Row Styling for JS injected content */
    .column-row {
        background: #ffffff !important;
        border: 1px solid var(--enterprise-border) !important;
        border-left: 4px solid var(--enterprise-blue) !important;
        transition: all 0.2s ease;
    }

    .column-row:hover {
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .fk-row {
        background: #ffffff !important;
        border: 1px solid var(--enterprise-border) !important;
        border-left: 4px solid #fd7e14 !important;
        transition: all 0.2s ease;
    }

    .fk-row:hover {
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .btn-remove {
        color: #dc3545;
        border-color: transparent;
    }

    .btn-remove:hover {
        background-color: #fff5f5;
        border-color: #dc3545;
    }

    pre code {
        font-family: 'Fira Code', 'Courier New', monospace;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .form-check-input:checked {
        background-color: var(--enterprise-blue);
        border-color: var(--enterprise-blue);
    }
</style>

<script>
    let columnCount = 0;
    let fkCount = 0;

    // Initialize with one column
    document.addEventListener('DOMContentLoaded', function () {
        addColumn();
    });

    function addColumn() {
        columnCount++;
        const container = document.getElementById('columnsContainer');

        const columnDiv = document.createElement('div');
        columnDiv.className = 'column-row p-3 mb-2 rounded-3 shadow-sm';
        columnDiv.id = `column-${columnCount}`;

        columnDiv.innerHTML = `
        <div class="row g-3 align-items-center">
            <div class="col-md-3">
                <label class="small text-muted mb-1 d-block fw-bold">Name</label>
                <input type="text" class="form-control form-control-sm" placeholder="e.g. user_id" 
                       id="colName-${columnCount}" required>
            </div>
            <div class="col-md-2">
                <label class="small text-muted mb-1 d-block fw-bold">Type</label>
                <select class="form-select form-select-sm" id="colType-${columnCount}">
                    <option value="int">INT</option>
                    <option value="str" selected>STR</option>
                    <option value="float">FLOAT</option>
                </select>
            </div>
            <div class="col-md-5">
                <label class="small text-muted mb-1 d-block fw-bold">Constraints</label>
                <div class="d-flex gap-3 mt-1">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="colPrimary-${columnCount}" 
                               onchange="handlePrimaryKeyChange(${columnCount})">
                        <label class="form-check-label small" for="colPrimary-${columnCount}">
                            PK
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="colUnique-${columnCount}">
                        <label class="form-check-label small" for="colUnique-${columnCount}">
                            Unique
                        </label>
                    </div>
                </div>
            </div>
            <div class="col-md-2 text-end pt-3">
                <button type="button" class="btn btn-sm btn-remove" 
                        onclick="removeColumn(${columnCount})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;

        container.appendChild(columnDiv);
    }

    function removeColumn(id) {
        const element = document.getElementById(`column-${id}`);
        if (element) {
            element.remove();
        }
    }

    function handlePrimaryKeyChange(id) {
        const checkbox = document.getElementById(`colPrimary-${id}`);
        if (checkbox.checked) {
            // Uncheck all other primary key checkboxes
            for (let i = 1; i <= columnCount; i++) {
                if (i !== id) {
                    const otherCheckbox = document.getElementById(`colPrimary-${i}`);
                    if (otherCheckbox) {
                        otherCheckbox.checked = false;
                    }
                }
            }
        }
    }

    function addForeignKey() {
        fkCount++;
        const container = document.getElementById('foreignKeysContainer');
        const noFKMsg = document.getElementById('noForeignKeys');
        if (noFKMsg) noFKMsg.style.display = 'none';

        const fkDiv = document.createElement('div');
        fkDiv.className = 'fk-row p-3 mb-2 rounded-3 shadow-sm';
        fkDiv.id = `fk-${fkCount}`;

        // Get available tables from the data attribute
        const metadataStore = document.getElementById('metadata-store');
        const availableTables = JSON.parse(metadataStore.dataset.tables || '[]');

        fkDiv.innerHTML = `
            <div class="row g-2 align-items-center">
                <div class="col-md-3">
                    <label class="form-label small mb-1 fw-bold text-muted">Local Column</label>
                    <select class="form-select form-select-sm" id="fkLocal-${fkCount}">
                        <option value="">Select column...</option>
                    </select>
                </div>
                <div class="col-md-1 text-center pt-3">
                    <i class="fas fa-arrow-right text-muted opacity-50"></i>
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1 fw-bold text-muted">Ref Table</label>
                    <select class="form-select form-select-sm" id="fkRefTable-${fkCount}" 
                            onchange="updateRefColumns(${fkCount})">
                        <option value="">Select table...</option>
                        ${availableTables.map(t => '<option value="' + t + '">' + t + '</option>').join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1 fw-bold text-muted">Ref Column</label>
                    <select class="form-select form-select-sm" id="fkRefCol-${fkCount}">
                        <option value="">Select column...</option>
                    </select>
                </div>
                <div class="col-md-2 text-end pt-3">
                    <button type="button" class="btn btn-sm btn-remove" 
                            onclick="removeForeignKey(${fkCount})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;

        container.appendChild(fkDiv);
        updateLocalColumns(fkCount);
    }

    function removeForeignKey(id) {
        const element = document.getElementById(`fk-${id}`);
        if (element) {
            element.remove();
        }

        // Check if any FKs remain
        const container = document.getElementById('foreignKeysContainer');
        if (container.children.length === 1) { // Only noForeignKeys div remains
            document.getElementById('noForeignKeys').style.display = 'block';
        }
    }

    function updateLocalColumns(fkId) {
        const select = document.getElementById('fkLocal-' + fkId);
        if (!select) return;

        const currentValue = select.value;
        select.innerHTML = '<option value="">Select column...</option>';

        // Get all defined columns
        for (let i = 1; i <= columnCount; i++) {
            const colName = document.getElementById('colName-' + i);
            if (colName && colName.value) {
                const option = document.createElement('option');
                option.value = colName.value;
                option.textContent = colName.value;
                if (colName.value === currentValue) option.selected = true;
                select.appendChild(option);
            }
        }
    }

    async function updateRefColumns(fkId) {
        const tableSelect = document.getElementById('fkRefTable-' + fkId);
        const colSelect = document.getElementById('fkRefCol-' + fkId);
        const tableName = tableSelect.value;

        colSelect.innerHTML = '<option value="">Loading...</option>';

        if (!tableName) {
            colSelect.innerHTML = '<option value="">Select column...</option>';
            return;
        }

        try {
            // Fetch table schema
            const response = await fetch('/api/table/' + tableName + '/columns');
            if (response.ok) {
                const data = await response.json();
                colSelect.innerHTML = '<option value="">Select column...</option>';
                data.columns.forEach(col => {
                    const option = document.createElement('option');
                    option.value = col;
                    option.textContent = col;
                    colSelect.appendChild(option);
                });
            }
        } catch (error) {
            colSelect.innerHTML = '<option value="">Error loading columns</option>';
        }
    }

    function buildSQL() {
        const tableName = document.getElementById('tableName').value.trim();
        if (!tableName) {
            return null;
        }

        const columns = [];
        const foreignKeys = [];

        // Collect columns
        for (let i = 1; i <= columnCount; i++) {
            const nameInput = document.getElementById('colName-' + i);
            if (!nameInput || !nameInput.value.trim()) continue;

            const name = nameInput.value.trim();
            const type = document.getElementById('colType-' + i).value;
            const isPrimary = document.getElementById('colPrimary-' + i).checked;
            const isUnique = document.getElementById('colUnique-' + i).checked;

            let colDef = name + ' ' + type.toUpperCase();
            if (isPrimary) {
                colDef += ' PRIMARY KEY';
            } else if (isUnique) {
                colDef += ' UNIQUE';
            }

            columns.push(colDef);
        }

        // Collect foreign keys
        for (let i = 1; i <= fkCount; i++) {
            const localCol = document.getElementById('fkLocal-' + i);
            const refTable = document.getElementById('fkRefTable-' + i);
            const refCol = document.getElementById('fkRefCol-' + i);

            if (localCol && refTable && refCol &&
                localCol.value && refTable.value && refCol.value) {
                foreignKeys.push(
                    'FOREIGN KEY (' + localCol.value + ') REFERENCES ' + refTable.value + '(' + refCol.value + ')'
                );
            }
        }

        const allParts = columns.concat(foreignKeys);
        return 'CREATE TABLE ' + tableName + ' (' + allParts.join(', ') + ')';
    }

    function showSQLPreview() {
        const sql = buildSQL();
        if (!sql) {
            showAlert('Please enter a table name and at least one column', 'warning');
            return;
        }

        document.getElementById('sqlPreviewCode').textContent = sql;
        const modal = new bootstrap.Modal(document.getElementById('sqlPreviewModal'));
        modal.show();
    }

    function copySQL() {
        const sql = document.getElementById('sqlPreviewCode').textContent;
        navigator.clipboard.writeText(sql).then(function () {
            showAlert('SQL copied to clipboard!', 'success');
        });
    }

    async function createTable() {
        const tableName = document.getElementById('tableName').value.trim();

        if (!tableName) {
            showAlert('Please enter a table name', 'warning');
            return;
        }

        // Collect columns data
        const columns = [];
        for (let i = 1; i <= columnCount; i++) {
            const nameInput = document.getElementById('colName-' + i);
            if (!nameInput || !nameInput.value.trim()) continue;

            columns.push({
                name: nameInput.value.trim(),
                type: document.getElementById('colType-' + i).value,
                is_primary: document.getElementById('colPrimary-' + i).checked,
                is_unique: document.getElementById('colUnique-' + i).checked
            });
        }

        if (columns.length === 0) {
            showAlert('Please add at least one column', 'warning');
            return;
        }

        // Collect foreign keys
        const foreignKeys = [];
        for (let i = 1; i <= fkCount; i++) {
            const localCol = document.getElementById('fkLocal-' + i);
            const refTable = document.getElementById('fkRefTable-' + i);
            const refCol = document.getElementById('fkRefCol-' + i);

            if (localCol && refTable && refCol &&
                localCol.value && refTable.value && refCol.value) {
                foreignKeys.push({
                    local_column: localCol.value,
                    ref_table: refTable.value,
                    ref_column: refCol.value
                });
            }
        }

        // Send to server
        try {
            const response = await fetch('/create_table', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    table_name: tableName,
                    columns: columns,
                    foreign_keys: foreignKeys
                })
            });

            const result = await response.json();

            if (result.success) {
                showAlert("Table '" + tableName + "' created successfully!", 'success');
                setTimeout(function () {
                    window.location.href = '/table/' + tableName;
                }, 1500);
            } else {
                showAlert('Error: ' + result.error, 'danger');
            }
        } catch (error) {
            showAlert('Network error: ' + error.message, 'danger');
        }
    }

    function showAlert(message, type) {
        const container = document.getElementById('alertContainer');
        const alert = document.createElement('div');
        alert.className = 'alert alert-' + type + ' alert-dismissible fade show border-0 shadow-sm';
        alert.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        container.appendChild(alert);

        setTimeout(function () { alert.remove(); }, 5000);
    }

    function resetForm() {
        if (confirm('Are you sure you want to reset the form?')) {
            location.reload();
        }
    }

    // Update local column dropdowns when column names change
    setInterval(function () {
        for (let i = 1; i <= fkCount; i++) {
            const fkElement = document.getElementById('fk-' + i);
            if (fkElement) {
                updateLocalColumns(i);
            }
        }
    }, 1000);
</script>
{% endblock %}