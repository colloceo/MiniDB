{% extends "base.html" %}

{% block title %}{{ table_name }} - Structure - MiniDB Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2 dashboard-title">
        <i class="fas fa-project-diagram me-2 text-primary"></i>
        Table Structure: <span class="text-primary fw-bold">{{ table_name }}</span>
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="/table/{{ table_name }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-table me-1"></i> Browse Data
            </a>
            <a href="/sql-console" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-terminal me-1"></i> SQL Console
            </a>
        </div>
    </div>
</div>

<!-- Alert Messages -->
{% if msg %}
<div class="alert {% if 'Error' in msg %}alert-danger{% else %}alert-success{% endif %} alert-dismissible fade show border-0 shadow-sm"
    role="alert">
    {{ msg }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- Tab Navigation -->
<ul class="nav nav-tabs mb-4 px-3 border-bottom-0">
    <li class="nav-item">
        <a class="nav-link" href="/table/{{ table_name }}">
            <i class="fas fa-eye me-1"></i> Browse Data
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link active fw-bold border-bottom-0" href="/table/{{ table_name }}/structure">
            <i class="fas fa-project-diagram me-1"></i> Structure
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="/table/{{ table_name }}/operations">
            <i class="fas fa-tools me-1"></i> Operations
        </a>
    </li>
</ul>

<!-- Table Structure Card -->
<div class="card border-light-gray shadow-xs mb-4">
    <div class="card-header bg-white py-3 border-bottom">
        <h5 class="mb-0 fw-bold text-dark">
            <i class="fas fa-list me-2 text-muted"></i> Column Definitions
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 py-3 text-muted small fw-bold text-uppercase"
                            style="width: 5%; letter-spacing: 0.05em;">#</th>
                        <th class="py-3 text-muted small fw-bold text-uppercase"
                            style="width: 30%; letter-spacing: 0.05em;">Column Name</th>
                        <th class="py-3 text-muted small fw-bold text-uppercase"
                            style="width: 20%; letter-spacing: 0.05em;">Data Type</th>
                        <th class="py-3 text-muted small fw-bold text-uppercase"
                            style="width: 15%; letter-spacing: 0.05em;">Key</th>
                        <th class="pe-4 py-3 text-muted small fw-bold text-uppercase text-end"
                            style="width: 30%; letter-spacing: 0.05em;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for col in columns %}
                    <tr>
                        <td class="ps-4 text-muted small">{{ loop.index }}</td>
                        <td>
                            <span class="fw-bold text-dark">{{ col.name }}</span>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border fw-normal">{{ col.type }}</span>
                        </td>
                        <td>
                            {% if col.key == 'PRI' %}
                            <span class="badge bg-primary shadow-sm" style="font-size: 0.7rem;">
                                <i class="fas fa-key me-1"></i> PRIMARY
                            </span>
                            {% elif col.key == 'UNI' %}
                            <span class="badge bg-light text-success border-success border-opacity-25"
                                style="font-size: 0.7rem; color: #198754 !important;">
                                <i class="fas fa-shield-alt me-1"></i> UNIQUE
                            </span>
                            {% elif col.key == 'MUL' %}
                            <span class="badge bg-light text-info border-info border-opacity-25"
                                style="font-size: 0.7rem; color: #0dcaf0 !important;">
                                <i class="fas fa-link me-1"></i> FOREIGN
                            </span>
                            {% else %}
                            <span class="text-muted opacity-50 small">â€”</span>
                            {% endif %}

                            {% if col.is_fk %}
                            <div class="mt-1">
                                <small class="text-muted" style="font-size: 0.75rem;">
                                    <i class="fas fa-arrow-right me-1 opacity-50"></i>
                                    <code>{{ col.fk_ref }}</code>
                                </small>
                            </div>
                            {% endif %}
                        </td>
                        <td class="pe-4 text-end">
                            {% if col.key != 'PRI' %}
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary btn-sm"
                                    onclick="openRenameModal('{{ col.name }}')" title="Rename column">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm"
                                    onclick="openDropModal('{{ col.name }}')" title="Drop column">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            {% else %}
                            <span class="text-muted small italic">Locked (PK)</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer bg-white border-top py-3">
        <span class="text-muted small">
            <i class="fas fa-info-circle me-1 opacity-50"></i>
            Total Columns: <strong>{{ columns|length }}</strong>
        </span>
    </div>
</div>

<!-- Add Column Section (Panel Style) -->
<div class="card border-light-gray shadow-xs mb-5">
    <div class="card-header bg-white py-3 border-bottom">
        <h5 class="mb-0 fw-bold text-dark">
            <i class="fas fa-plus-circle me-2 text-primary"></i> Schema Modification
        </h5>
    </div>
    <div class="card-body p-4">
        <form method="POST" id="addColumnForm">
            <div class="row g-4 align-items-end">
                <div class="col-md-5">
                    <label for="column_name" class="section-title mb-2 d-block">
                        New Column Name
                    </label>
                    <input type="text" class="form-control enterprise-input" id="column_name" name="column_name"
                        placeholder="e.g. status, created_at" required>
                    <div class="form-text mt-2">Lowercase alphanumeric only.</div>
                </div>

                <div class="col-md-4">
                    <label for="column_type" class="section-title mb-2 d-block">
                        Data Type
                    </label>
                    <select class="form-select enterprise-input" id="column_type" name="column_type" required>
                        <option value="int">INT (Integer)</option>
                        <option value="str" selected>STR (String)</option>
                        <option value="float">FLOAT (Decimal)</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100 py-2 shadow-sm">
                        <i class="fas fa-plus me-1"></i> Add Column
                    </button>
                </div>
            </div>
        </form>

        <div class="mt-4 p-3 bg-light rounded border border-light">
            <div class="d-flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-lightbulb text-warning"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <p class="mb-0 small text-secondary">
                        <strong>Note:</strong> Existing rows will be populated with default values (<code>0</code> for
                        INT, <code>''</code> for STR, <code>0.0</code> for FLOAT).
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SQL Preview Section -->
<div class="card border-0 shadow-xs mb-5" style="background-color: #fcfcfc; border: 1px solid #eee !important;">
    <div class="card-header bg-transparent py-2 border-bottom-0">
        <span class="text-uppercase small fw-bold text-muted" style="letter-spacing: 0.1em;">SQL Preview</span>
    </div>
    <div class="card-body py-2">
        <pre
            class="m-0 bg-transparent ps-0"><code id="sqlPreview" class="text-primary small" style="font-family: 'Fira Code', monospace;">-- Enter column details above to see the SQL command</code></pre>
    </div>
</div>

<!-- Modals (Stylized) -->

<!-- Rename Column Modal -->
<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-bottom bg-light">
                <h5 class="modal-title fw-bold text-dark"><i class="fas fa-edit me-2 text-primary"></i> Rename Column
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/table/{{ table_name }}/rename_column">
                <div class="modal-body p-4">
                    <input type="hidden" name="old_name" id="renameOldName">

                    <p class="text-muted small mb-4">
                        Renaming column <strong id="renameCurrentName" class="text-dark"></strong>. This operation will
                        preserve all existing data.
                    </p>

                    <div class="mb-3">
                        <label for="renameNewName" class="section-title mb-2 d-block">New Column Name</label>
                        <input type="text" class="form-control enterprise-input" id="renameNewName" name="new_name"
                            placeholder="Enter new name..." required>
                    </div>
                </div>
                <div class="modal-footer bg-light border-top">
                    <button type="button" class="btn btn-link text-muted text-decoration-none"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary px-4">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Drop Column Modal -->
<div class="modal fade" id="dropModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-bottom bg-light">
                <h5 class="modal-title fw-bold text-danger"><i class="fas fa-exclamation-triangle me-2"></i> Drop Column
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/table/{{ table_name }}/drop_column">
                <div class="modal-body p-4">
                    <input type="hidden" name="column_name" id="dropColumnName">

                    <div class="text-center mb-4">
                        <div class="display-6 text-danger mb-2"><i class="fas fa-trash-alt"></i></div>
                        <h5 class="fw-bold">Delete Column?</h5>
                        <p class="text-muted">
                            You are about to permanently remove <strong id="dropCurrentName" class="text-dark"></strong>
                            from table <strong>{{ table_name }}</strong>.
                        </p>
                    </div>

                    <div class="p-3 bg-danger bg-opacity-10 border border-danger border-opacity-25 rounded mb-4">
                        <ul class="mb-0 small text-danger">
                            <li>All data in this column will be <strong>erased</strong>.</li>
                            <li>Associated indices and unique constraints will be removed.</li>
                            <li>This action <strong>cannot be undone</strong>.</li>
                        </ul>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="dropConfirm" required>
                        <label class="form-check-label small fw-bold" for="dropConfirm">
                            I understand and wish to proceed with deleting this column
                        </label>
                    </div>
                </div>
                <div class="modal-footer bg-light border-top">
                    <button type="button" class="btn btn-link text-muted text-decoration-none"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger px-4">Drop Column</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    :root {
        --enterprise-blue: #0d6efd;
        --enterprise-dark: #343a40;
        --enterprise-muted: #6c757d;
        --enterprise-border: #dee2e6;
        --enterprise-bg: #f8f9fa;
    }

    body {
        background-color: var(--enterprise-bg);
    }

    .dashboard-title {
        font-weight: 700;
        color: var(--enterprise-dark);
        letter-spacing: -0.02em;
    }

    .section-title {
        font-size: 0.75rem;
        text-transform: uppercase;
        font-weight: 700;
        color: var(--enterprise-muted);
        letter-spacing: 0.05em;
    }

    .border-light-gray {
        border-color: var(--enterprise-border) !important;
    }

    .shadow-xs {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
    }

    .enterprise-input {
        border-color: var(--enterprise-border);
        border-radius: 6px;
        padding: 0.6rem 0.75rem;
    }

    .enterprise-input:focus {
        border-color: var(--enterprise-blue);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
    }

    .nav-tabs .nav-link {
        border: none;
        color: var(--enterprise-muted);
        padding: 0.75rem 1.25rem;
        border-bottom: 2px solid transparent;
        font-size: 0.9rem;
    }

    .nav-tabs .nav-link:hover {
        background-color: transparent;
        color: var(--enterprise-blue);
        border-bottom-color: #eee;
    }

    .nav-tabs .nav-link.active {
        background-color: transparent;
        color: var(--enterprise-blue);
        border-bottom: 2px solid var(--enterprise-blue);
    }

    .table thead th {
        border-top: none;
        background-color: #fcfcfc;
    }

    code {
        background-color: #f8f9fa;
        color: #d63384;
        padding: 0.1rem 0.3rem;
        border-radius: 4px;
        font-size: 0.85em;
    }

    pre code {
        color: var(--enterprise-blue);
        background: transparent;
    }

    .italic {
        font-style: italic;
    }
</style>

<script>
    // Real-time SQL preview
    document.getElementById('column_name').addEventListener('input', updateSQLPreview);
    document.getElementById('column_type').addEventListener('change', updateSQLPreview);

    function updateSQLPreview() {
        const colName = document.getElementById('column_name').value.trim();
        const colType = document.getElementById('column_type').value.toUpperCase();
        const tableName = "{{ table_name }}";

        const preview = document.getElementById('sqlPreview');

        if (colName) {
            preview.textContent = `ALTER TABLE ${tableName} ADD ${colName} ${colType}`;
        } else {
            preview.textContent = '-- Enter column details above to see the SQL command';
        }
    }

    // Form validation
    document.getElementById('addColumnForm').addEventListener('submit', function (e) {
        const colName = document.getElementById('column_name').value.trim();

        if (!colName) {
            e.preventDefault();
            alert('Please enter a column name');
            return false;
        }

        // Confirm action handled by browser checkbox in modal usually, but for simple form:
        const colType = document.getElementById('column_type').value.toUpperCase();
        const confirmed = confirm(
            `Are you sure you want to add column '${colName}' (${colType}) to table '{{ table_name }}'?`
        );

        if (!confirmed) {
            e.preventDefault();
            return false;
        }
    });

    // Auto-focus on column name input
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('column_name').focus();
    });

    // Open Rename Modal
    function openRenameModal(columnName) {
        document.getElementById('renameOldName').value = columnName;
        document.getElementById('renameCurrentName').textContent = columnName;
        document.getElementById('renameNewName').value = '';

        const modal = new bootstrap.Modal(document.getElementById('renameModal'));
        modal.show();

        // Focus on new name input after modal opens
        setTimeout(() => {
            document.getElementById('renameNewName').focus();
        }, 500);
    }

    // Open Drop Modal
    function openDropModal(columnName) {
        document.getElementById('dropColumnName').value = columnName;
        document.getElementById('dropCurrentName').textContent = columnName;
        document.getElementById('dropConfirm').checked = false;

        const modal = new bootstrap.Modal(document.getElementById('dropModal'));
        modal.show();
    }
</script>
{% endblock %}